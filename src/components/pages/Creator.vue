<template>
  <div class="container">
    <div v-if="account===null" class="container" style="text-align: left;">
      <h4>{{ $t("m.noWeb3")}}</h4>
      <p class="pt-2">{{ $t("m.noWeb3desc")}}</p>
      <br>
      <br>
      <b-row class="logoRow">
        <b-col class="wallet-button" cols="6" id="imToken" v-if="!portisEthDenverLink">
          <a target="__blank" v-b-toggle.collapse1 variant="primary">
            <span>
              <img class="walletIcon" src="/static/icons/imToken_color.png">
              <p>imToken</p>
              <p class="walletDesc">{{ $t("m.mobileWallet")}}</p>
            </span>
          </a>
          <b-collapse id="collapse1" class="wallet-reg mt-2">
            <b-card>
              <div class="walletDesc">{{ $t("m.newUser")}}</div>
              <a target="__blank" href="https://token.im/download">{{ $t("m.install")}}</a>
              <br>
              <hr>
              <div class="walletDesc">{{ $t("m.existingUser")}}</div>
              <a target="__blank" :href="generateDeepURL()">{{ $t("m.logIn")}}</a>
            </b-card>
          </b-collapse>
        </b-col>
        <b-col class="wallet-button" cols="6" id="trust">
          <a target="__blank">
            <span @click="initPortis" v-if="portisClicked===false">
              <img class="walletIcon" src="/static/icons/portis.png">
              <p>Portis</p>
              <p class="walletDesc">{{ $t("m.webWallet")}}</p>
            </span>
            <span v-if="portisClicked">{{ $t("m.pleaseWait2")}}</span>
          </a>
        </b-col>
      </b-row>
      <!--<b-row class="logoRow">
        <b-col cols="6" id="status">
          <a target="__blank" href="https://status.im">
            <img class="walletIcon" src="/static/icons/status.png">
            <p>Status</p>
            <p class="walletDesc">{{ $t("m.mobileWallet")}}</p>
          </a>
        </b-col>
        <b-col cols="6" id="opera">
          <a target="__blank" href="https://www.opera.com/crypto">
            <img class="walletIcon" src="/static/icons/opera.png">
            <p>Opera</p>
            <p class="walletDesc">{{ $t("m.mobileWallet")}}</p>
          </a>
        </b-col>
      </b-row>-->
      <b-row class="logoRow">
        <b-col class="wallet-button" cols="6" id="metamask" v-if="!portisEthDenverLink">
          <a target="__blank" href="https://metamask.io">
            <img class="walletIcon" src="/static/icons/metamask.png">
            <p>MetaMask</p>
            <p class="walletDesc">{{ $t("m.chromeAddon")}}</p>
          </a>
        </b-col>
        <b-col class="wallet-button" cols="6" id="portis">
          <div>
            <span v-if="portisClicked===false" @click="initPortis">
              <img class="walletIcon" src="/static/icons/portis.png">
              <p>Portis</p>
              <p class="walletDesc">{{ $t("m.webWallet")}}</p>
            </span>
            <span v-if="portisClicked">{{ $t("m.pleaseWait2")}}</span>
          </div>
        </b-col>
      </b-row>
    </div>
    <form v-if="account!=null && account != undefined">
      <div role="tablist">
        <div class="section step step--twocol step1" v-if="step === 0">
          <div class="step__card">
            <card v-if="cards && this.card !== undefined" :cdata="this.formData.card"></card>
          </div>
          <div class="flex-column">
            <div class="step__info">
              <div class="step__title">
                <h4>{{ $t("m.customiseCard")}}</h4>
              </div>
              <!--<div class="input-label">
                <img src="/static/icons/warning.svg" alt style="width: 0.9rem;">
                {{ $t("m.addMessage")}}
              </div>-->
              <b-form-textarea
                id="textarea"
                class="field"
                v-model="formData.message"
                v-bind:placeholder="$t('m.sendMessage')"
                :rows="3"
                :max-rows="6"
              ></b-form-textarea>

              <br>
              <input
                type="button"
                class="button button--fullwidth"
                :disabled="!formData.message"
                @click="goToStep(1)"
                value="NEXT"
              >
            </div>
          </div>
        </div>

        <!-- select where funds are going page -->
        <div class="section step step--twocol step2" v-if="step === 1">
          <div class="step__card">
            <card v-if="cards && this.card !== undefined" :cdata="previewCardObject"></card>
          </div>
          <div class="flex-column">
            <div class="step__title">
              <h4>{{ $t("m.sendMethod")}}</h4>
            </div>

            <div class="fieldgroup--radio column">
              <!-- QR -->
              <div :class="['field field--radio', {'isSelected': formData.sendingMethod === 'QR'}]">
                <input type="radio" id="selectQR" value="QR" v-model="formData.sendingMethod">
                <label for="selectQR" class="field--radio__content">
                  <span v-if="formData.sendingMethod !== 'QR'" class="pretext">{{ $t("m.QR")}}</span>
                  <div v-if="formData.sendingMethod === 'QR'" class="sendOptionSelectedContent">
                    <p class="p--bold">{{ $t("m.QR")}}</p>
                  </div>
                </label>
              </div>

              <!-- ETH -->
              <div
                :class="['field field--radio', {'isSelected': formData.sendingMethod === 'ETH'}]"
              >
                <input type="radio" id="selectETH" value="ETH" v-model="formData.sendingMethod">
                <label for="selectETH" class="field--radio__content">
                  <span
                    v-if="formData.sendingMethod !== 'ETH'"
                    class="pretext"
                  >{{ $t("m.addEthWallet")}}</span>
                  <div v-if="formData.sendingMethod === 'ETH'" class="sendOptionSelectedContent">
                    <p class="p--bold">{{ $t("m.addEthWallet")}}</p>
                    <input
                      type="text"
                      placeholder="0x..."
                      class="field form-control"
                      v-model="formData.recipient"
                    >
                  </div>
                </label>
              </div>

              <!-- Self -->
              <div
                :class="['field field--radio', {'isSelected': formData.sendingMethod === 'Self'}]"
              >
                <input type="radio" id="selectSelf" value="Self" v-model="formData.sendingMethod">
                <label for="selectSelf" class="field--radio__content">
                  <span
                    v-if="formData.sendingMethod !== 'Self'"
                    class="pretext"
                  >{{ $t("m.sendOwn")}}</span>
                  <div v-if="formData.sendingMethod === 'Self'" class="sendOptionSelectedContent">
                    <p class="p--bold">{{ $t("m.sendOwn")}}</p>
                    <br>
                    <p>{{ $t("m.yourWallet")}}</p>
                    <p class="p--smallitalic small-account">{{account}}</p>
                  </div>
                </label>
              </div>
            </div>
            <br>
            <br>
            <input
              type="button"
              class="button button--fullwidth"
              :disabled="!validateSendingMethod()"
              @click="goToStep(2)"
              value="NEXT"
            >
            <!-- <p
              v-if="formData.sendingMethod==='QR'"
            >If you choose to generate a claimable link an extra 0.01ETH will be added as a fee.</p>-->
          </div>
        </div>

        <!-- add donation page -->
        <div class="section step step--twocol step2" v-if="step === 2">
          <div class="step__card">
            <card v-if="cards && this.card !== undefined" :cdata="previewCardObject"></card>
          </div>
          <div class="flex-column">
            <div class="step__title">
              <h4>{{ $t("m.topUp")}}</h4>
            </div>

            <div class="fieldgroup--radio column">
              <!-- Option 1 -->
              <div :class="['field field--radio', {'isSelected': formData.currency === 'ETH'}]">
                <input type="radio" id="selectETH" value="ETH" v-model="formData.currency">
                <label for="selectETH" class="field--radio__content">
                  <p class="p--smallitalic">{{ $t("m.topUpCrypto")}}</p>
                  <span v-if="formData.currency !== 'ETH'" class="pretext">{{ $t("m.sendEth")}}</span>

                  <div v-if="formData.currency === 'ETH'" class="sendOptionSelectedContent">
                    <p class="p--bold">{{ $t("m.sendEth")}}</p>
                    <input
                      type="number"
                      class="field form-control"
                      v-model="formData.valueInETH"
                      step="0.1"
                      :min="premuimCardInformation.minInEth"
                    >
                    <p
                      class="p--smallitalic"
                    >{{equivalentFiatCost(formData.valueInETH)}}USD / {{equivalentCynCost(formData.valueInETH)}}RMB</p>
                    <div class="paymentPresets">
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInETH == 0.2}]"
                        @click="setDonationAmount(0.2)"
                      >0.2 ETH</button>
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInETH == 0.5}]"
                        @click="setDonationAmount(0.5)"
                      >0.5 ETH</button>
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInETH == 1}]"
                        @click="setDonationAmount(1)"
                      >1 ETH</button>
                    </div>
                  </div>
                </label>
              </div>

              <div :class="['field field--radio', {'isSelected': formData.currency === 'DAI'}]">
                <input type="radio" id="selectDAI" value="DAI" v-model="formData.currency">
                <label for="selectDAI" class="field--radio__content">
                  <p class="p--smallitalic">{{ $t("m.topUpStable")}}</p>
                  <span v-if="formData.currency !== 'DAI'" class="pretext">{{ $t("m.sendStable")}}</span>
                  <div v-if="formData.currency === 'DAI'" class="sendOptionSelectedContent">
                    <p class="p--bold">{{ $t("m.sendStable")}}</p>
                    <input
                      type="number"
                      class="field form-control"
                      v-model="formData.valueInDAI"
                      :step="0.5"
                      :min="premuimCardInformation.minInDai"
                    >
                    <div class="paymentPresets">
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInDAI == 25}]"
                        @click="setDonationAmount(25)"
                      >25 DAI</button>
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInDAI == 60}]"
                        @click="setDonationAmount(60)"
                      >60 DAI</button>
                      <button
                        :class="['button button--outline', {'isSelected' : formData.valueInDAI == 120}]"
                        @click="setDonationAmount(120)"
                      >120 DAI</button>
                    </div>
                  </div>
                </label>
              </div>
            </div>

            <h4 class="margin">{{ $t("m.donateCharity")}}</h4>
            <div class="row" style="margin-left: 0;">
              <select class="margin charity-drop col-4" v-model="formData.benefactor">
                <option v-for="item in benefactors" :value="item" v-bind:key="item.name">{{item.name}}</option>
              </select>
              <vue-slider
                class="margin col-8"
                style="padding: 12px"
                ref="slider"
                v-bind="donationSliderOptions"
                v-model="formData.percentage"
                formatter="{value}%"
              ></vue-slider>
            </div>
            <br>
            <br>
            <input
              type="button"
              class="button button--fullwidth"
              :disabled="!validateDonationMethod()"
              @click="giveBirth"
              v-bind:value="$t('m.createHongbao')"
            >
            <p
              v-if="formData.currency === 'ETH' && formData.valueInETH > ethBalance"
            >{{ $t("m.noETH")}}{{parseFloat(ethBalance).toFixed(3)}}.</p>
            <p
              v-if="formData.currency === 'DAI' && formData.valueInDAI > daiBalance"
            >{{ $t("m.noDAI")}}{{parseFloat(daiBalance).toFixed(3)}}.</p>
            <p v-if="formData.currency === 'DAI'">{{ $t("m.sendDAI")}}</p>

            <p
              v-if="formData.currency === 'ETH' && formData.valueInETH * usdPrice < formData.card.cardMinPrice"
            >{{ $t("m.donateCharity")}}{{parseFloat(formData.card.cardMinPrice / usdPrice).toFixed(3)}} ETH.</p>
            <p
              v-if="formData.currency === 'DAI' && formData.valueInDAI < formData.card.cardMinPrice"
            >{{ $t("m.donateCharity")}}{{parseFloat(formData.card.cardMinPrice).toFixed(3)}} DAI.</p>
          </div>
        </div>

        <!-- CONFIRMATION PAGE -->
        <div
          class="section step step--twocol step2"
          v-if="step === 3 && !getGiftingStatus(account, formData.card.cardIndex).status"
        >
          <div class="step__card">
            <card v-if="cards && this.card !== undefined" :cdata="previewCardObject"></card>
          </div>
          <div class="flex-column">
            <div class="step__title">
              <h4>{{ $t("m.ready")}}</h4>
              <!--<p>{{ $t("m.readyDesc")}}</p>-->
              <div class="flex-column">
                <div v-if="formData.sendingMethod==='Self'">
                  <div class="alignleft">
                    <div class="input-label">
                      <img src="/static/icons/send.svg" alt style="width: 0.9rem;"> to be sent to my ETH wallet
                    </div>
                  </div>
                  <h5></h5>
                </div>
                <div v-if="formData.sendingMethod==='ETH'">
                  <div class="alignleft">
                    <div class="input-label">
                      <img src="/static/icons/send.svg" alt style="width: 0.9rem;"> to be sent to ETH address
                    </div>
                  </div>
                  <h5>{{formData.recipient}}</h5>
                </div>
                <br>
                <div v-if="formData.sendingMethod==='QR'">
                  <div class="alignleft">
                    <!-- <div class="input-label">
                      <img src="/static/icons/send.svg" alt style="width: 0.9rem;"> to be sent via email, WeChat or other chat apps
                    </div>-->
                  </div>
                  <br>
                </div>
                <br>
                <div v-if="formData.currency==='ETH'">
                  <h5 class="alignleft">{{ $t("m.recipientGift")}}</h5>
                  <h5
                    class="alignright"
                  >{{(formData.valueInETH*(100 - formData.percentage)/100).toFixed(3)}} ETH</h5>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{equivalentFiatCost((formData.valueInETH*(100 - formData.percentage)/100).toFixed(3))}} $ / {{equivalentCynCost((formData.valueInETH*(100 - formData.percentage)/100).toFixed(3))}} ¥</div>
                  </div>
                  <br>
                  <!-- <hr> -->
                  <br>
                  <h5 class="alignleft">{{ $t("m.charity")}}</h5>
                  <h5
                    class="alignright"
                  >{{(formData.valueInETH*formData.percentage/100).toFixed(3)}} ETH</h5>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{equivalentFiatCost((formData.valueInETH*formData.percentage/100).toFixed(3))}} $ / {{equivalentCynCost((formData.valueInETH*formData.percentage/100).toFixed(3))}} ¥</div>
                  </div>
                  <br>
                  <br>
                  <div v-if="formData.sendingMethod==='QR'">
                    <h5 class="alignleft">{{ $t("m.networkFee")}}</h5>
                    <h5 class="alignright">{{ephemeralAddressFee}} ETH</h5>
                    <br>
                    <div class="alignright">
                      <div
                        class="input-label-currency"
                      >{{equivalentFiatCost(ephemeralAddressFee)}} $ / {{equivalentCynCost(ephemeralAddressFee)}} ¥</div>
                    </div>
                    <br>
                    <br>
                  </div>

                  <hr>
                  <h4 class="alignleft">{{ $t("m.totalCost")}}</h4>
                  <h4
                    class="alignright"
                  >{{formData.sendingMethod==='QR' ? (parseFloat(formData.valueInETH) + parseFloat(ephemeralAddressFee)).toFixed(3): formData.valueInETH}} ETH</h4>
                  <br>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{formData.sendingMethod==='QR' ? equivalentFiatCost(parseFloat(formData.valueInETH) + parseFloat(ephemeralAddressFee)) + " $ / " + equivalentCynCost(parseFloat(formData.valueInETH) + parseFloat(ephemeralAddressFee)) + " ¥": equivalentFiatCost(formData.valueInETH) + " $ / " + equivalentCynCost(formData.valueInETH) + " ¥"}}</div>
                  </div>
                </div>

                <div v-if="formData.currency==='DAI'">
                  <h5 class="alignleft">{{ $t("m.recipientGift")}}</h5>
                  <h5
                    class="alignright"
                  >{{(formData.valueInDAI*(100 - formData.percentage)/100).toFixed(3)}} DAI</h5>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{(formData.valueInDAI*(100 - formData.percentage)/100).toFixed(3)}} $ / {{((formData.valueInDAI*(100 - formData.percentage)/100)/cynPrice).toFixed(3)}} ¥</div>
                  </div>
                  <br>
                  <!-- <hr> -->
                  <br>
                  <h5 class="alignleft">{{ $t("m.charity")}}</h5>
                  <h5
                    class="alignright"
                  >{{(formData.valueInDAI*formData.percentage/100).toFixed(3)}} DAI</h5>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{(formData.valueInDAI*formData.percentage/100).toFixed(3)}} $ / {{((formData.valueInDAI*formData.percentage/100)/cynPrice).toFixed(3)}} ¥</div>
                  </div>
                  <br>
                  <br>
                  <div v-if="formData.sendingMethod==='QR'">
                    <h5 class="alignleft">{{ $t("m.networkFee")}}</h5>
                    <h5 class="alignright">{{ephemeralAddressFee}} ETH</h5>
                    <br>
                    <div class="alignright">
                      <div
                        class="input-label-currency"
                      >{{equivalentFiatCost(ephemeralAddressFee)}} $ / {{equivalentCynCost(ephemeralAddressFee)}} ¥</div>
                    </div>
                    <br>
                    <br>
                  </div>
                  <hr>
                  <h4 class="alignleft">{{ $t("m.totalCost")}}</h4>
                  <h4
                    class="alignright"
                  >{{formData.sendingMethod==='QR' ? parseFloat(ephemeralAddressFee) + " ETH & " + parseFloat(formData.valueInDAI) + " DAI" : parseFloat(formData.valueInDAI) + " DAI"}}</h4>
                  <br>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{formData.sendingMethod==='QR' ? (parseFloat(equivalentFiatCost(ephemeralAddressFee)) + parseFloat(formData.valueInDAI)).toFixed(2) + " $ / " +(parseFloat(equivalentCynCost(ephemeralAddressFee)) + parseFloat(formData.valueInDAI)).toFixed(2) + " ¥": (parseFloat(formData.valueInDAI)).toFixed(2) + " $ / " + ((parseFloat(formData.valueInDAI))/cynPrice).toFixed(2) + " ¥"}}</div>
                  </div>
                </div>

                <!-- <div v-if="formData.currency==='DAI'">
                  <h5 class="alignleft">Card cost</h5>
                  <h5 class="alignright">{{formData.valueInDAI}} DAI</h5>
                  <br>
                  <h5 class="alignleft">Charity</h5>
                  <h5
                    class="alignright"
                  >{{(formData.valueInDAI*formData.percentage/100).toFixed(3)}} DAI</h5>
                  <br>
                  <div class="alignright">
                    <div
                      class="input-label-currency"
                    >{{(formData.valueInDAI*(100 - formData.percentage)/100).toFixed(3)}} DAI</div>
                  </div>
                </div>
                <hr>
                <div>
                  <div v-if="formData.currency==='DAI'">
                    <h4
                      v-if="formData.sendingMethod==='QR'"
                      class="alignright"
                    >{{parseFloat(ephemeralAddressFee)}} ETH</h4>
                    <h4
                      v-if="formData.sendingMethod!=='QR'"
                      class="alignright"
                    >{{parseFloat(formData.valueInDAI)}} DAI</h4>
                  </div>
                </div>-->
                <!-- <strong>Card Message:</strong>
                <br>
                <p class="p--smallitalic">{{formData.message}}</p>-->
              </div>
              <br>
              <input
                type="button"
                class="button button--fullwidth"
                @click="giveBirth"
                v-bind:value="$t('m.createHongbao')"
              >
            </div>
          </div>
        </div>

        <!-- STATUS: SUBMITTED -->
        <div
          class="section step step--twocol step4"
          v-if="step === 3 && getGiftingStatus(account, formData.card.cardIndex).status === 'TRIGGERED'"
        >
          <div class="step__card">
            <div class="centered">
              <card v-if="formData.card" :cdata="previewCardObject"/>
            </div>
          </div>

          <div class="step__info">
            <br>

            <h4>{{ $t("m.transactionTriggered")}}</h4>
            <br>
            <p>{{ $t("m.transactionTriggeredDesc")}}</p>

            <h4
              v-if="formData.currency=='DAI' && daiAllowance < formData.valueInDAI"
            >{{ $t("m.DAIDisclaimer")}}</h4>
            <p
              v-if="formData.currency=='DAI' && daiAllowance < formData.valueInDAI"
            >{{ $t("m.DAIDisclaimer2")}}</p>
          </div>
        </div>

        <!-- STATUS: SUBMITTED -->
        <div
          class="section step step--twocol step4"
          v-if="step === 3 && getGiftingStatus(account, formData.card.cardIndex).status === 'SUBMITTED'"
        >
          <div class="step__card">
            <div class="centered">
              <card v-if="formData.card" :cdata="previewCardObject"/>
            </div>
          </div>

          <div class="step__info">
            <div class="loading-spinner">
              <div class="loading-spinner-inner">
                <div class="holder">
                  <div class="box"></div>
                </div>
                <div class="holder">
                  <div class="box"></div>
                </div>
                <div class="holder">
                  <div class="box"></div>
                </div>
              </div>
            </div>

            <br>

            <h4>{{ $t("m.cardCreated")}}</h4>
            <p>{{ $t("m.cardCreatedDesc")}}</p>
            <br>
            <p>{{ $t("m.cardCreatedDesc2")}}</p>
            <br>
            <p v-if="getGiftingStatus(account, formData.card.cardIndex).tx">
              {{ $t("m.cardCreatedDesc4")}}
              <a
                class="a--external"
                :href="etherscanBase + '/tx/' + getGiftingStatus(account, formData.card.cardIndex).tx"
                target="_blank"
              >{{ $t("m.cardCreatedDesc5")}}</a>
            </p>
          </div>
        </div>

        <!-- STATUS: SUCCESS -->
        <div
          class="section step step--twocol step5"
          v-if="(step === 3 && getGiftingStatus(account, formData.card.cardIndex).status === 'SUCCESS')"
        >
          <div class="step__card">
            <div class="centered">
              <card v-if="formData.card" :cdata="previewCardObject"/>
            </div>
          </div>
          <div class="step__info">
            <img src="/static/icons/success.png" alt style="width: 5rem;">
            <br>
            <br>

            <h4>{{$t("m.rock")}}</h4>

            <p v-if="formData.sendingMethod != 'QR'">
              {{$t("m.sendSuccess")}}
              <clickable-address :eth-address="formData.recipient"></clickable-address>
            </p>
            <div class="qr" v-if="formData.sendingMethod=='QR'">
              {{$t("m.claimableLink")}}
              <br>
              <div class="qr-link">
                <qr-code-image :link="'https://radi.cards/claim/' + ephemeralPrivateKey"></qr-code-image>
              </div>
              <!-- <div class="claim-url">https://radi.cards/claim/{{ephemeralPrivateKey}}</div> -->
              <a
                :href="'https://radi.cards/claim/' + ephemeralPrivateKey"
                target="_blank"
                class="claim-url"
              >{{ $t("m.yourLink")}}</a>
              <br>
              <a
                @click="copyToClipboard('https://radi.cards/claim/' + ephemeralPrivateKey)"
                target="_blank"
                class="btn btn--narrow btn--subtle"
                style="margin-top: 0.5rem;"
              >{{ $t("m.copyLink")}}</a>
              <div v-if="copied">
                <p class="p--smallitalic">{{ $t("m.linkCopied")}}</p>
              </div>
            </div>

            <br>

            <!-- <div class="share-box">
              <h2>{{$t("m.shareOthers")}}</h2>
              <br>
              <span class="subtext">{{$t("m.shareOthersEmail")}}</span>
              <br>
              <div class="email-field">
                <input
                  type="email"
                  class="field form-control"
                  style="margin-bottom:0px;"
                  v-model="formData.email"
                >
                <mailto-link
                  v-if="formData.email && formData.email.length > 0"
                  :email="formData.email"
                  subject="You've received a Radi.Card!"
                  :body-text="'Hi there!\n\nSomeone sent you a radicard!\n\nTo see it, go here:\nhttps://radi.cards/card/' + getGiftingStatus(account, formData.card.cardIndex).tokenId + '\n\n\n100% income (after gas fee) goes to https://eff.org or other charity of your choice.\nSpread the joy and send crypto eCards to your friends at https://radi.cards.\n\n----------------------------------\n\nDo you know that your radicard is a Non-Fungible Token?\nThis means that it is unique and only created just for you.\n\nHowever, you can only keep your card (token) in an Ethereum wallet.\nSo go install one from MetaMask, Trustwallet, MyEtherwallet or Coinbase wallet.\nOnce you have your own wallet, ask your friend to transfer the token to you. EZ!'"
                >send</mailto-link>
              </div>
              <span class="subtext">{{$t("m.shareOthersLink")}}</span>
              <div class="copy-field">
                <a
                  id="copyfield"
                  :href="'https://radi.cards/card/' + getGiftingStatus(account, formData.card.cardIndex).tokenId"
                  target="_blank"
                  class="field form-control"
                >
                  <strong>{{'radi.cards/card/' + getGiftingStatus(account, formData.card.cardIndex).tokenId}}</strong>
                </a>
                <div
                  @click="copyToClipboard('https://radi.cards/card/' + getGiftingStatus(account, formData.card.cardIndex).tokenId)"
                  target="_blank"
                >copy</div>
              </div>
            </div>-->
            <div>
              <button
                @click="startOverCreation"
                style="width:100%; margin-top:20px;"
                class="btn pick"
              >{{$t("m.pickAnother")}}</button>
            </div>
          </div>
        </div>

        <!-- STATUS: FAILED -->
        <div
          class="section step step--twocol step6"
          v-if="step === 3 && getGiftingStatus(account, formData.card.cardIndex).status === 'FAILURE'"
        >
          <div class="step__card">
            <div class="centered">
              <card v-if="formData.card" :cdata="previewCardObject"/>
            </div>
          </div>

          <div class="step__info">
            <h4>{{$t("m.oops")}}</h4>

            <p>{{$t("m.oopsDesc")}}</p>
            <br>
            <p class="pb-3">
              <strong>{{$t("m.checkWallet")}}</strong>
              {{$t("m.checkWalletDesc")}}
            </p>

            <button @click="startOverCreation" class="btn">{{$t("m.startOver")}}</button>
            <button class="btn" @click="giveBirth">{{$t("m.retry")}}</button>
            <p v-if="getGiftingStatus(account, formData.card.cardIndex).tx">
              {{$t("m.viewEthScan")}}
              <a
                class="a--external"
                :href="etherscanBase + '/tx/' + getGiftingStatus(account, formData.card.cardIndex).tx"
                target="_blank"
              >{{$t("m.cardCreatedDesc5")}}</a>
            </p>
          </div>
        </div>
      </div>
    </form>
  </div>
</template>

<script>
import router from "../../router";
import { mapGetters, mapState } from "vuex";
import * as _ from "lodash";
import Web3 from "web3";
import * as actions from "../../store/actions";
import ClickableTransaction from "../widgets/ClickableTransaction";
import ClickableAddress from "../widgets/ClickableAddress";
import Card from "../../components/widgets/Card";
import Benefactor from "../../components/widgets/Benefactor";
import Samplequote from "../../components/widgets/SampleQuote";
import MailtoLink from "../../components/widgets/MailtoLink";
import QrCodeImage from "../../components/widgets/QRCodeImage";
import { AssertionError } from "assert";
import vueSlider from "vue-slider-component";
import Portis from "@portis/web3";

export default {
  name: "creator",
  components: {
    ClickableTransaction,
    QrCodeImage,
    Card,
    Benefactor,
    Samplequote,
    MailtoLink,
    ClickableAddress,
    vueSlider
  },
  data() {
    return {
      portisClicked: false,
      donationSliderOptions: {
        eventType: "auto",
        width: "auto",
        height: 4,
        dotSize: 10,
        dotHeight: null,
        dotWidth: null,
        min: 0,
        max: 100,
        interval: 1,
        show: true,
        speed: 0.5,
        disabled: false,
        piecewise: false,
        usdKeyboard: false,
        enableCross: true,
        tooltip: "always",
        tooltipDir: "top",
        reverse: false,
        clickable: true,
        realTime: false,
        lazy: false,
        formatter: null,
        bgStyle: {
          backgroundColor: "#414141",
          boxShadow: "inset 0.5px 0.5px 3px 1px rgba(0,0,0,.36)"
        },
        sliderStyle: {
          backgroundColor: "#414141"
        },
        tooltipStyle: { backgroundColor: "#414141", borderColor: "#414141" },
        processStyle: {
          backgroundColor: "#414141"
        },
        piecewiseActiveStyle: null,
        labelStyle: null,
        labelActiveStyle: null
      },
      formData: {
        errors: [],
        card: {},
        valueInETH: 0.02,
        valueInDAI: 60,
        recipient: 0,
        percentage: 5,
        benefactor: {
          address: "0xb189f76323678e094d4996d182a792e52369c005",
          name: "Electronic Frontier Foundation",
          website: "https://www.eff.org",
          image:
            "https://ipfs.infura.io/ipfs/QmY9ECy55kWevPJQ2RDYJxDmB16h5J8SfhEyuEUAUnAyGU",
          id: 1
        },
        message: null,
        currency: null
      },
      step: 0,
      walletVisible: false,
      response: {
        ipfsHash: null
      },
      copied: false
    };
  },
  computed: {
    ...mapState([
      "etherscanBase",
      "account",
      "uploadedHashs",
      "cards",
      "benefactors",
      "usdPrice",
      "ephemeralAddressFee",
      "ethBalance",
      "daiBalance",
      "daiAllowance",
      "ephemeralPrivateKey",
      "cynPrice",
      "portisEthDenverLink"
    ]),
    ...mapGetters(["getGiftingStatus"]),
    cardMessageFormatted() {
      return this.formData.message.replace(/\r?\n/g, "<br />");
    },
    previewCardObject() {
      return {
        ...this.formData.card,
        ...{
          message: this.cardMessageFormatted,
          BenefactorIndex: this.formData.benefactor.id,
          giftAmount: this.formData.valueInETH
        }
      };
    },

    card() {
      var cIndex = this.$route.params.cardIndex;
      console.log(cIndex);

      for (var c = 0; c < this.cards.length; c++) {
        if (this.cards[c].cardIndex + "" === cIndex + "") {
          this.formData.card = this.cards[c];
          return this.cards[c];
        }
      }
    },
    premuimCardInformation() {
      let cardInfoObject = {
        minInEth: 0,
        minInDai: 0,
        sendValueUSD: 0,
        sendValueOTHER: 0
      };
      if (this.card.cardMaxQnty > 0) {
        // the min price for the card in eth will be the card price in usd
        //deviled by the current usd/eth price as defined by the oracle
        cardInfoObject.minInEth = (
          this.card.cardMinPrice / this.usdPrice
        ).toFixed(2);
        cardInfoObject.minInDai = this.card.cardMinPrice;
      }

      return cardInfoObject;
    }
  },
  mounted() {
    this.$nextTick(function() {});
  },
  methods: {
    generateDeepURL() {
      return (
        "imtokenv2://navigate/DappView?url=https://radi.cards" +
        this.$route.fullPath
      );
    },
    initPortis() {
      this.portisClicked = true;
      const portis = new Portis(
        "90dd46f3-6a56-4162-85dc-f310c53cced7",
        "mainnet"
      );
      const provider = portis.provider;
      window.web3 = new Web3(provider);
      this.$store.dispatch(actions.INIT_APP, window.web3);
      this.$store.dispatch(actions.PORTIS_SIGNED_IN, { portis });
    },
    equivalentFiatCost(ethAmount) {
      return parseFloat(ethAmount * this.usdPrice).toFixed(2);
    },
    equivalentCynCost(ethAmount) {
      return (parseFloat(ethAmount * this.usdPrice) / this.cynPrice).toFixed(2);
    },
    startOverCreation: function(event) {
      event.preventDefault();
      this.$store.dispatch(actions.RESET_GIFT_STATUS);
      this.$router.push({ name: "cardshop" });
    },
    validateDonationMethod() {
      // valid input
      if (
        this.formData.currency === undefined ||
        this.formData.currency === null
      ) {
        return false;
      }

      if (this.formData.percentage === undefined) {
        return false;
      }

      if (this.formData.benefactor === undefined) {
        return false;
      }

      // user has enough balance to send card
      if (
        this.formData.currency === "ETH" &&
        this.formData.valueInETH > this.ethBalance
      ) {
        return false;
      }

      if (
        this.formData.currency === "DAI" &&
        this.formData.valueInDAI > this.daiBalance
      ) {
        return false;
      }

      // user enough has been selected for the price of the card
      if (
        this.formData.currency === "ETH" &&
        this.formData.valueInETH * this.usdPrice <
          this.formData.card.cardMinPrice
      ) {
        return false;
      }

      if (
        this.formData.currency === "DAI" &&
        this.formData.valueInDAI < this.formData.card.cardMinPrice
      ) {
        return false;
      }
      return true;
    },
    validateSendingMethod() {
      if (this.formData.sendingMethod === undefined) {
        return false;
      }

      if (this.formData.sendingMethod === "ETH") {
        return Web3.utils.isAddress(this.formData.recipient);
      }

      return true;
    },
    copyToClipboard(text) {
      this.$copyText(text);
      this.copied = true;
    },
    handelBenefactorSelected(item) {
      this.setBenefactor(item);
    },
    goToStep(pageNumber) {
      if (this.step === 0 && this.portisEthDenverLink) {
        console.log("DEEP PORTIS LINK");
        this.step = 3;
        this.formData.valueInETH = 0.02;
        this.formData.percentage = 100;
        this.formData.currency = "ETH";
        this.formData.sendingMethod = "Self";
      } else {
        this.step = pageNumber;
      }
    },
    setDonationAmount(amount) {
      event.preventDefault();
      if (this.formData.currency === "ETH") {
        console.log("saving eth " + this.formData.currency + amount);
        this.formData.valueInETH = amount;
      } else {
        console.log("saving DAI " + this.formData.currency + amount);
        this.formData.valueInDAI = amount;
      }
    },
    setBenefactor(benefactor) {
      this.formData.benefactor = benefactor;
      this.step = 2;
    },
    selectCard(card) {
      if (this.formData.card === card) {
        this.formData.card = null;
      } else {
        this.formData.card = card;
      }
    },
    giveBirth: function(event) {
      event.preventDefault();

      this.checkForm();
      var recipient;
      var totalSendAmount;
      let claimableLink;
      let transactionValue;
      let currency;

      switch (this.formData.sendingMethod) {
        case "QR":
          recipient = null; //ephemeral address is generated in the store
          claimableLink = true;
          break;
        case "ETH":
          recipient = this.formData.recipient;
          claimableLink = false;
          break;
        case "Self":
          recipient = this.account;
          this.formData.recipient = recipient;
          claimableLink = false;
          break;
        default:
          this.formData.errors.push("Invalid send method selected");
      }
      switch (this.formData.currency) {
        case "ETH":
          currency = "ETH";
          totalSendAmount = this.formData.valueInETH;
          //the value in eth should be equal to the total selected for both gift and donation
          transactionValue = parseFloat(totalSendAmount);
          if (claimableLink) {
            //if the link is claimable we must add the ephemeral fee
            console.log(transactionValue);
            transactionValue += parseFloat(this.ephemeralAddressFee);
          }
          break;
        case "DAI":
          currency = "DAI";
          totalSendAmount = this.formData.valueInDAI;
          // in the case of dai we dont need to send any eth with (unless it is a claimable link)
          transactionValue = 0;
          if (claimableLink) {
            //if the link is claimable we must add the ephemeral fee
            transactionValue += parseFloat(this.ephemeralAddressFee);
          }
          break;
        default:
          this.formData.errors.push("Invalid currency type selected");
      }
      var donationAmount = (
        (totalSendAmount * this.formData.percentage) /
        100
      ).toFixed(10);
      var giftAmount = totalSendAmount - donationAmount;

      // last thing to do is to cast the donation,gift and transaction values to strings
      // as they are converted to wei in the store and this requires string or bignumber inputs
      donationAmount = donationAmount.toString();
      giftAmount = giftAmount.toFixed(10).toString();
      transactionValue = transactionValue.toFixed(10).toString();
      console.log(transactionValue);

      if (this.formData.errors.length === 0) {
        let benefactorIndex = this.formData.benefactor.id;
        let cardIndex = this.formData.card.cardIndex;
        let message = this.formData.message;
        this.$store.dispatch(actions.MINT_CARD, {
          currency,
          recipient,
          benefactorIndex,
          cardIndex,
          message,
          donationAmount,
          giftAmount,
          claimableLink,
          transactionValue
        });
      }
    },
    checkForm: function() {
      this.formData.errors = [];
      if (this.formData.sendOptions === "wallet" && !this.formData.recipient) {
        this.formData.errors.push("Recipient is required.");
      } else if (
        this.formData.sendOptions === "wallet" &&
        !Web3.utils.isAddress(this.formData.recipient)
      ) {
        this.formData.errors.push("Recipient not valid address.");
      }
      // if (this.formData.valueInETH < 0.02) {
      //   this.formData.errors.push("Value must be at least 0.02ETH");
      // }
      if (!this.formData.message) {
        this.formData.errors.push("Message is required.");
      }
      if (this.formData.message && this.formData.message.length > 128) {
        this.formData.errors.push("Message is too long! Max 128 characters.");
      }
      if (this.formData.card === {}) {
        this.formData.errors.push("Card is required.");
      }
    }
  }
};
</script>

<style lang="scss" scoped>
@import "../../styles/variables.scss";
@import "../../styles/mixins.scss";

.pick {
  background: rgba(196, 196, 196, 0.2);
  color: black;
  line-height: normal;
  font-size: 18px;
  font-weight: bold;
}

.margin {
  margin-top: 10px;
  margin-bottom: 10px;
}

.charity-drop {
  color: $darkgray;
  border: 0px solid $darkgray;
  height: 30px;
  width: 100%;
}

.share-box {
  background: white;
  padding: 20px;
}
.field {
  background: white;
}

.subtext {
  line-height: normal;
  font-size: 14px;
  color: $darkgray;
  opacity: 0.9;
}

.email-field {
  display: flex;
  flex-direction: row;
  margin-bottom: 20px;

  a {
    color: white;
    background: black;
    padding: 0px 15px;
    line-height: 38px;
  }

  .copy-field {
    display: flex;
    flex-direction: row;

    #copyfield {
      background: rgba(196, 196, 196, 0) !important;
      border: 0;
    }

    div {
      color: $darkgray;
      background: rgba(196, 196, 196, 0.15);
      padding: 9px 10px;
      height: 100%;
      border: 0px;
      margin: 0px;
    }
  }
}

.card-selected {
  margin-top: -1rem;
  transition: all 0.2s ease-in-out;
}

.info {
  line-height: normal;
  font-size: 12px;

  color: $darkgray;
}

.input-label {
  font-size: 0.9rem;
  color: $darkred;
  text-align: left;
  width: 100%;
  padding-bottom: 0.15rem;
}
.input-label-currency {
  font-size: 0.8rem;
  color: $gray;
  background-color: $greylightest;
  padding-top: 0.2rem;
  padding-bottom: 0.2rem;
  padding-left: 0.3rem;
  padding-right: 0.3rem;
  border-radius: 0.5rem;
}

input,
textarea {
  margin-bottom: 1rem;
  width: 100%;
}
// textarea {
//   border: 1px solid $darkgray;

//   &::placeholder {
//     text-align: right;
//     text-align-last: right;
//     vertical-align: bottom;
//   }
// }

.paymentPresets {
  display: flex;
  margin-top: 20px;
  justify-content: space-between;
}

.wallet {
  position: relative;
  display: none;
  padding: 0.75rem 1rem;
  border-radius: 0;
  font-size: 12px;
  background: rgba(0, 0, 0, 0.05);

  &.isVisible {
    display: block;
  }

  &__actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-direction: column;

    @include tabletAndUp() {
      flex-direction: row;
    }
  }

  &__collapse {
    position: absolute;
    top: 0;
    right: 0;
    padding: 0.75rem;
    cursor: pointer;
  }

  .btn {
    align-self: flex-end;
  }
}

.btn {
  white-space: normal;
}

.qr-link {
  word-wrap: break-word;
  padding-right: 1.5rem;
}

.claim-url {
  overflow-wrap: break-word;
  word-wrap: break-word;
  hyphens: auto;
}

.wallet-reg {
  box-shadow: 0 0.1rem 0.4rem rgba($gray, 0.3);
}

.wallet-button {
  padding-top: 0.8rem;
  padding-bottom: 0.6rem;
  padding-left: 0.7rem;
  padding-right: -0.5rem;
  transition: all 1s ease-in-out;

  &:visited {
    color: $white;
  }
  &:hover {
    -moz-transform: scale(1.03);
    -webkit-transform: scale(1.03);
    -o-transform: scale(1.03);
    -ms-transform: scale(1.03);
    -webkit-transform: scale(1.03);
    transform: scale(1.03);

    -webkit-transition: transform 1.05s ease-in-out;
    -moz-transition: transform 1.05s ease-in-out;
    -ms-transition: transform 1.05s ease-in-out;
  }
  &:focus {
    outline: none;
  }
}

.walletIcon {
  float: left;
  max-height: 40px;
  @media (max-width: 1000px) {
    padding-right: 100%;
  }
}

.walletDesc {
  font-size: 0.8rem;
  color: $gray;
}

.logoRow {
  padding-bottom: 1rem;
}

@media (min-width: 765px) {
  #imToken {
    display: none;
  }
  #trust {
    display: none;
  }
  #status {
    display: none;
  }
  #opera {
    display: none;
  }
}

@media (max-width: 765px) {
  #metamask {
    display: none;
  }
  #portis {
    display: none;
  }
}

// Steps preview (top)
.preview-step {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  margin: 0 -2rem;
  padding: 0.75rem 0.5rem 0.75rem 2rem;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  cursor: pointer;

  @include tabletAndUp() {
    flex-direction: row;
    align-items: center;
    margin: 0;
    padding: 0.5rem 0;
  }

  .section__title {
    margin-right: 1rem;
  }

  &__content {
    display: flex;
    flex: 1;
    width: 100%;
    justify-content: space-between;
    align-items: center;
  }

  &__text {
    margin-left: 1rem;
    margin-right: auto;
  }
  .selCard {
    line-height: normal;
    font-size: 14px;
  }
  .artist {
    line-height: normal;
    font-size: 14px;
  }

  h5 {
    line-height: normal;
    font-size: 14px;
    font-weight: bold;
  }

  .preview-step__img {
    width: 3rem;
    height: 3rem;

    img {
      max-width: 100%;
      max-height: 100%;
    }
  }
}

// Step Content
.step--twocol {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;

  .step__card {
    padding-left: 1rem;
    margin-bottom: 2rem;
    // color: white;
  }

  @include tabletAndUp() {
    flex-direction: row;
    justify-content: stretch;
    align-items: flex-start;

    .step__card {
      margin-right: 1rem;
    }
    .step__info {
      margin-left: 1rem;
    }
    .step__title {
      margin-top: 0;
      margin-bottom: 10px;
    }
  }
}

.centered {
  display: flex;
  justify-content: center;
  align-content: center;
}

.donationButton {
  background: white;
  color: black;
  line-height: normal;
  font-size: 16px;
  padding: 15px;
  border: 1px solid black;

  &.clicked {
    background: black;
    color: white;
    border: 0;
  }
}

.transaction-in-progress {
  width: 100%;

  background: $yellow;
  padding: 1rem;
}

.usdLabel {
  background: rgba(196, 196, 196, 0.3);
  padding: 10px;
  line-height: normal;
  font-size: 15px;
  display: inline-block;
  color: $darkgray;
}

.flex-column {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.small-address {
  font-size: 0.6rem;
}

// Confirmation
.alignleft {
  float: left;
}
.alignright {
  float: right;
}
</style>
